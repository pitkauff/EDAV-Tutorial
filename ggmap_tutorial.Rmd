---
title: "ggmap_tutorial"
author: "Pit Kauffmann"
date: "3/23/2018"
output: html_document
---

#Working With Location Data & ggmap

Working with geographical data can be both a blessing and a curse, so please enjoy the following tutorial on how to deal with location data and how to use ggmap to make some nice graphs. 

###Part 1: Working with Geographical Data

The main focus here will be on location data encoded as latitude, longitude. For the purpose of this tutorial, we will be working with the NYC citibike data, found [here](https://s3.amazonaws.com/tripdata/index.html). The data set for May 2015 looks as follows:

```{r message = FALSE, warning = FALSE}
setwd("~/Desktop/Umich files/TO 414 - R/Projects/CitiBike_Group5v4")
data = read.csv("201505-citibike-tripdata.csv")
str(data)
head(data)
```

The columns we will be focusing on are the start and end station latitudes and longitudes. Luckily in our case, we have all the location data, yet sometimes we may only be given partial information. Thankfully, ggmap has a built-in function that can very easily provide coordinates for certain locations. For example, if we wish to find the coordinates of Tulsa, OK and Munich, Germany, we would do the following:

```{r message = FALSE, warning = FALSE}
library(ggmap)
city_1 = "Tulsa, OK"
city_2 = "Munich, Germany"
geocode(city_1)
geocode(city_2)
```

The function is relatively flexible. We could have also said "Tulsa, Oklahoma" or "Munich, GE". Besides for city locations, the function can also retun more specific lat/lon pair, down to specific street addresses or known locations, for example:

```{r message = FALSE, warning = FALSE}
location_1 = "one infinite loop, cupertino"
location_2 = "Columbia University"
geocode(location_1)
geocode(location_2)
```

Pretty neat right!

Now, that we know what cool things we can do to prepare our dataset, we can now move on to make some maps.

###Part 2: Working with ggmap

ggmap is part of the Grammar of Graphics library package, so you get all the perks of gg and can easily combine ggmap with other ggplot graphs, as we will see shortly. The basic structure of how ggmap works is not particularly intuitive, so we'll quickly go over the setup before we get to the good stuff. Before actually being able to use the ggmap() function, we need to create a map object that tells ggmap what to plot. This is done as follows:

```{r message = FALSE, warning = FALSE}
map <- get_map(location = c(lon = -75.5, lat = 43.2), 
                 source = "google", 
                 maptype = "roadmap", 
                 crop = FALSE,
                 zoom = 7)
ggmap(map)
```

The main arguments for the get_map function are as follows:
* location: a list of a lat/lon pair. This pair essentially tells ggmap where to center its plot. In our case, we have chosen the coordinates, such that we can see New York State.
* source: can be either "goole", "osm", "stamen" or "cloudmade". This defines where ggmap is pulling the actual maps from.
* maptype: this defines the basic style of the displayed map. Maptype and source go together, hence not all combinations of are possible.
* zoom: this tells ggmap what area around the center to plot. Increase for zooming in, decrease for zooming out. Note that the zoom is pretty sensitive, so decreasing by what seems to be a small number will have a large effect.

By playing with the above 4 features, we can create some basic maps to start with, for example:

```{r message = FALSE, warning = FALSE}
# Zoom out
map_1 <- get_map(location = c(lon = -75.5, lat = 43.2), 
                 source = "google", 
                 maptype = "roadmap", 
                 crop = FALSE,
                 zoom = 3)
ggmap(map_1)

# Use a different source and map type
map_2 <- get_map(location = c(lon = -75.5, lat = 43.2), 
                 source = "stamen", 
                 maptype = "watercolor", 
                 crop = FALSE,
                 zoom = 7)
ggmap(map_2)
```

Note that you might get some strange error messages if you are not running the most up-to-date version of R. 
So far we have created some cool maps, but they're not really showing anything that I can't get from going to maps.google.com, so let's actually plot some things. Let's try to find which stations were most used during the Morning, defined as between 8am and 12pm.

```{r message = FALSE, warning = FALSE}
library(dplyr)
library(lubridate)

# Create time of day categories
time_of_day <- data %>% as.tbl %>% select(start.station.id, end.station.id, start.station.latitude,
  start.station.longitude, end.station.latitude, end.station.longitude, starttime) %>% mutate(start_time =
  {starttime %>% as.character %>% mdy_hms %>% hour}) %>% mutate(time_of_day = cut(start_time, breaks = c(-1, 8,
  12, 18, 24), labels = c("Early Morning", "Morning", "Afternoon", "Night")))

# Get all rides from the "Morning" category
time_of_day <- subset(time_of_day, time_of_day == "Morning")

# Obtain 10 busiest routes
most_pop <- time_of_day %>% mutate(count = 1) %>% group_by(start.station.id, end.station.id,
  start.station.latitude, start.station.longitude, end.station.latitude, end.station.longitude) %>% tally %>%
  ungroup %>% arrange(desc(n)) %>% slice(1:10) 

# Create map object
routes <- get_map(location = c(lon = -73.98767495, lat = 40.74), 
                    source = "google", 
                    maptype = "roadmap", 
                    zoom = 13)

# Plot the stations
ggmap(routes) + geom_segment(data = most_pop,
                               aes(x = start.station.longitude, 
                                   y = start.station.latitude, 
                                   xend = end.station.longitude, 
                                   yend = end.station.latitude), 
                               colour = "black", lwd = 0.7) +
                geom_point(data = most_pop, aes(x = start.station.longitude, y = start.station.latitude),
                           fill = "blue", shape = 21, size = 2) + 
                geom_point(data = most_pop, aes(x = end.station.longitude, y = end.station.latitude), 
                           fill = "blue", shape = 21, size = 2) + 
                labs(title = "Most Popular Routes bewteen 8am and 12pm")
```

Here routes that have the same start and end point are simply shown as a dot. Unfortuntely, this is the best we can do with the given data when it comes to plotting the routes. Since we have no location data for the actual trip, we can only plot the start and end locations.

Let's now take a look at which stations are most used (as both start and end stations) during different segments of the day

```{r message = FALSE, warning = FALSE, fig.width = 5, fig.height = 4}
# Create a new dataset that contains a row for each start station and each end station
s.s.loc <- select(data, start.station.id, start.station.latitude, start.station.longitude, starttime,
  tripduration) %>% mutate(id = as.factor("start")) %>% as.tbl
e.s.loc <- select(data, end.station.id, end.station.latitude, end.station.longitude, stoptime, tripduration) %>%
  mutate(id = as.factor("end")) %>% as.tbl

names(s.s.loc) <- c("station", "lat", "long", "time", "tripduration", "pos")
names(e.s.loc) <- c("station", "lat", "long", "time", "tripduration", "pos")

# Bind all the stations and break them into four time of day segments
locs <- rbind(e.s.loc, s.s.loc) %>% as.tbl %>% mutate(time =
  {time %>% as.character %>% mdy_hms %>% hour}) %>% mutate(time_of_day = cut(time, breaks = c(-1, 8,
  12, 18, 24), labels = c("Early Morning", "Morning", "Afternoon", "Night")))
locs$time <- as.factor(locs$time)

# Count how often each station is used for each of the time of day categories
locs.w.time <- locs %>% group_by(station, time_of_day, lat, long, time) %>% tally 

stations <- get_map(location = c(lon = -73.98767495, lat = 40.72603999), 
                 source = "google", 
                 maptype = "roadmap", 
                 zoom = 13)

# Plot the stations
ggmap(stations) + geom_point(aes(x = long, y = lat, colour = n), data = locs.w.time, size = 1.3) + 
                  facet_wrap( ~ time_of_day) + 
                  scale_color_gradient(low = "#C2DFFF", high = "#2554C7") + 
                  labs(title = "Activity Conditioned on Time of Day")
```

Finally, if you want to do something a little more involved

```{r}
for (i in 1:24) {
  tlocs <- filter(locs.w.time, time == levels(locs.w.time$time)[i])
  ggmap(stations) + geom_point(aes(long, lat, colour = rank(n)), size = 0.8, data = tlocs) + 
                    scale_color_gradient(low = "white", high = "red") + 
                    labs(title = paste("Hour:", levels(locs.w.time$time)[i]), cex.names = 0.75)
  ggsave(filename = paste("start", i, ".png", sep = ""), width = 4, height = 4, dpi = 200)
}
```







